<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">
<head>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<!-- 각 페이지의 CSS가 작성될 위치 -->
<th:block layout:fragment="css">
	<style>
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
	-webkit-appearance: none;
	margin: 0;
}
</style>
</th:block>
<div layout:fragment="content">

	<div class="bg-light py-3">
		<div class="container">
			<div class="row">
				<div class="col-md-12 mb-0">
					<a href="index.html">Home</a> <span class="mx-2 mb-0">/</span> <strong
						class="text-black">Cart</strong>
				</div>
			</div>
		</div>
	</div>

	<div class="site-section">
		<div class="container">
			<div class="row mb-5">
				<form class="col-md-12" th:each="cart : ${carts.getContent()}">
					<div class="site-blocks-table">
						<table class="table table-bordered">
							<thead>
								<tr>
									<th class="product-thumbnail">Image</th>
									<th class="product-name">Product</th>
									<th class="product-price">Price</th>
									<th class="product-quantity">Quantity</th>
									<th class="product-total">Total</th>
									<th class="product-remove">Remove</th>
								</tr>
							</thead>
							<tbody th:each="cartItem: ${cart.cartItemDtoList}">
								<tr>
									<td class="product-thumbnail"><img
										th:src="${cartItem.imgUrl}" th:alt="${cartItem.itemNm}"
										class="img-fluid"></td>
									<td class="product-name" th:text="${cartItem.itemNm}"></td>
									<td class="cartPrice" id="unitPrice"
										th:text="${#numbers.formatInteger(cartItem.cartPrice, 0, 'COMMA')}+'원'"></td>
									<td>
										<div class="input-group mb-3" style="max-width: 120px;">
											<div class="input-group-prepend">
												<button class="btn btn-outline-primary " type="button"
													onclick="updateQuantity('-')">−</button>
											</div>
											<input id="quantityInput" type="number"
												class="form-control text-center" value="1" min="0" max="999"
												placeholder="" aria-label="Example text with button addon"
												aria-describedby="button-addon1" oninput="updateTotal()">
											<div class="input-group-append">
												<button class="btn btn-outline-primary " type="button"
													onclick="updateQuantity('+')">+</button>
											</div>
										</div>
									</td>
									<td id="resultValue"></td>
									<td>
										<button type="button" class="btn btn-primary"
											th:value="${cart.cartId}" onclick="deleteCart(this.value)">삭제하기</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</form>
			</div>

			<div class="row">
				<div class="col-md-6">
					<div class="row mb-5">
						<div class="col-md-6 mb-3 mb-md-0">
							<button class="btn btn-primary btn-sm btn-block">Update
								Cart</button>
						</div>
						<div class="col-md-6">
							<button class="btn btn-outline-primary btn-sm btn-block">Continue
								Shopping</button>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<label class="text-black h4" for="coupon">Coupon</label>
							<p>Enter your coupon code if you have one.</p>
						</div>
						<div class="col-md-8 mb-3 mb-md-0">
							<input type="text" class="form-control py-3" id="coupon"
								placeholder="Coupon Code">
						</div>
						<div class="col-md-4">
							<button class="btn btn-primary btn-sm px-4">Apply Coupon</button>
						</div>
					</div>
				</div>
				<div class="col-md-6 pl-5">
					<div class="row justify-content-end">
						<div class="col-md-7">
							<div class="row">
								<div class="col-md-12 text-right border-bottom mb-5">
									<h3 class="text-black h4 text-uppercase">Cart Totals</h3>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<span class="text-black">Subtotal</span>
								</div>
								<div class="col-md-6 text-right">
									<strong class="text-black">$230.00</strong>
								</div>
							</div>
							<div class="row mb-5">
								<div class="col-md-6">
									<span class="text-black">Total</span>
								</div>
								<div class="col-md-6 text-right">
									<strong class="text-black">$230.00</strong>
								</div>
							</div>

							<div class="row">
								<div class="col-md-12">
									<button class="btn btn-primary btn-lg btn-block"
										onclick="window.location='checkout.html'">Proceed To
										Checkout</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 각 페이지의 스크립트가 작성될 위치 -->
<th:block layout:fragment="script">
	<script th:inline="javascript">
		function cancelCart(cartId) {
			const cancelconf = confirm("주문 취소하시겠습니까?");
			if (!cancelconf)
				return;

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");

			var url = "/cart/" + cartId + "/cancel";

			//서버로 보내줄 데이터(반드시 JSON  -> string 타입으로 바꿔야한다.)
			var paramData = {
				cartId : cartId
			};

			var param = JSON.stringify(paramData);

			$.ajax({
				url : url,
				type : "POST", //전송방식
				contentType : "application/json",
				data : param,
				beforeSend : function(xhr) {
					//데이터를 전송하기 전에 헤더에 xsrf값
					xhr.setRequestHeader(header, token);
				},
				dataType : "json",
				cache : false,
				success : function(result, status) {
					var path = location.pathname;
					var page = path.substring(path.lastIndexOf("/") + 1);
					if (page == 'carts') {
						page = 0;
					}

					//주문취소 후에 해당 페이지로 이동시켜준다.
					location.href = '/carts/' + page;
				},
				error : function(jqXHR, status, error) {
					if (jqXHR.status == '401') {
						alert('로그인 후 이용해주세요.');
						location.href = '/member/login';
					} else {
						alert(jqXHR.responseText);
					}
				}
			});
		}

		function deleteCart(cartId) {
			const deleteconf = confirm("주문 내역을 삭제하시겠습니까?");
			if (!deleteconf)
				return;

			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");

			var url = "/cart/" + cartId + "/delete";

			$.ajax({
				url : url,
				type : "DELETE", //전송방식
				contentType : "application/json",
				beforeSend : function(xhr) {
					//데이터를 전송하기 전에 헤더에 xsrf값
					xhr.setRequestHeader(header, token);
				},
				dataType : "json",
				cache : false,
				success : function(result, status) {
					location.href = '/carts';
				},
				error : function(jqXHR, status, error) {
					if (jqXHR.status == '401') {
						alert('로그인 후 이용해주세요.');
						location.href = '/member/login';
					} else {
						alert(jqXHR.responseText);
					}
				}
			});
		}

		//값조정
		let unitPrice = parseInt(document.getElementById('unitPrice').innerText
				.replace(/[^\d]/g, '')); // 숫자만 추출
		let quantityInput = document.getElementById('quantityInput');
		let resultValue = document.getElementById('resultValue');
		const minValue = 0;
		const maxValue = 999;

		// 페이지 로드 시 초기화 함수 호출
		window.onload = function() {
			updateTotal();
		};

		// 수량 및 총 가격 업데이트 함수
		function updateQuantity(operator) {
			let quantity = parseInt(quantityInput.value) || 0; // 공백일 경우 0으로 설정

			if (operator === '+' && quantity < maxValue) {
				quantity = (quantity < 0) ? minValue : quantity + 1; // 0 이하일 경우 최소값부터 시작
			} else if (operator === '-' && quantity > minValue) {
				quantity--;
			}

			quantityInput.value = quantity;
			updateTotal();
		}

		// 수량에 따라 총 가격 업데이트 함수
		function updateTotal() {
			let quantity = parseInt(quantityInput.value) || 0; // 공백일 경우 0으로 설정
			quantity = Math.min(maxValue, Math.max(minValue, quantity)); // 최소값과 최대값으로 조정
			let total = unitPrice * quantity;
			resultValue.innerText = total.toLocaleString() + '원'; // 콤마 추가
		}
	</script>
</th:block>
</html>